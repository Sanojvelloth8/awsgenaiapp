name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "destroy" to confirm deletion of all resources'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: genapp
  ENVIRONMENT: dev

jobs:
  destroy:
    name: Destroy AWS Resources
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "destroy" ]; then
            echo "âŒ Confirmation failed. You must type 'destroy' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation validated. Proceeding with resource destruction..."

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -reconfigure

      - name: Delete ECR Images
        continue-on-error: true
        run: |
          # Delete all images from backend repository
          BACKEND_REPO="${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-backend"
          aws ecr batch-delete-image \
            --repository-name $BACKEND_REPO \
            --image-ids "$(aws ecr list-images --repository-name $BACKEND_REPO --query 'imageIds[*]' --output json)" \
            --region ${{ env.AWS_REGION }} || true
          
          # Delete all images from frontend repository
          FRONTEND_REPO="${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-frontend"
          aws ecr batch-delete-image \
            --repository-name $FRONTEND_REPO \
            --image-ids "$(aws ecr list-images --repository-name $FRONTEND_REPO --query 'imageIds[*]' --output json)" \
            --region ${{ env.AWS_REGION }} || true

      - name: Force Delete S3 Bucket Contents
        continue-on-error: true
        run: |
          # Find and empty the S3 bucket created by Terraform
          BUCKET_NAME=$(aws s3 ls | grep "${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-docs-" | awk '{print $3}')
          if [ ! -z "$BUCKET_NAME" ]; then
            echo "Emptying S3 bucket: $BUCKET_NAME"
            aws s3 rm s3://$BUCKET_NAME --recursive --region ${{ env.AWS_REGION }} || true
          fi

      - name: Terraform Destroy
        working-directory: terraform
        run: terraform destroy -auto-approve

      - name: Cleanup OpenSearch Collections (if any remain)
        continue-on-error: true
        run: |
          # List and delete any remaining OpenSearch Serverless collections
          COLLECTIONS=$(aws opensearchserverless list-collections --region ${{ env.AWS_REGION }} --query "collectionSummaries[?contains(name, '${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}')].id" --output text)
          for COLLECTION_ID in $COLLECTIONS; do
            echo "Deleting OpenSearch collection: $COLLECTION_ID"
            aws opensearchserverless delete-collection --id $COLLECTION_ID --region ${{ env.AWS_REGION }} || true
          done

      - name: Cleanup Knowledge Bases (if any remain)
        continue-on-error: true
        run: |
          # List and delete any remaining Knowledge Bases
          KB_IDS=$(aws bedrock-agent list-knowledge-bases --region ${{ env.AWS_REGION }} --query "knowledgeBaseSummaries[?contains(name, '${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}')].knowledgeBaseId" --output text)
          for KB_ID in $KB_IDS; do
            echo "Deleting Knowledge Base: $KB_ID"
            aws bedrock-agent delete-knowledge-base --knowledge-base-id $KB_ID --region ${{ env.AWS_REGION }} || true
          done

      - name: Destruction Summary
        run: |
          echo "## ðŸ—‘ï¸ Resources Destroyed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All AWS resources for **${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}** have been deleted:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Cluster and Services" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ALB and Target Groups" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECR Repositories" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VPC and Networking" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… S3 Buckets" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DynamoDB Tables" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cognito User Pool" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bedrock Knowledge Base" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OpenSearch Serverless Collection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** OIDC provider and IAM roles were NOT deleted as they may be used by other projects." >> $GITHUB_STEP_SUMMARY
